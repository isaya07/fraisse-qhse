import{d as ie,G as ne,g as re,f as de,h as V,i as D,j as ue,c as p,a as s,p as _,b as l,w as n,u as i,s as y,t as r,x as ce,e as b,r as me,k as pe,H as ve,m as z,n as fe,F as ye,I as xe,y as ge,o as u}from"./index-oOuEsLBu.js";import{u as _e}from"./indicators-DW2GygZt.js";import{s as h}from"./index-CO5Pw-j-.js";import{s as E}from"./index-B3ik4ugR.js";import{s as be}from"./index-Cho6rYmn.js";import{s as he,a as k}from"./index-obDBiGqA.js";import{s as M}from"./index-D4NNOuL2.js";import{s as B}from"./index-D25kfrV8.js";import{s as R}from"./index-CYWC0yQY.js";import"./index-DXuF__Dl.js";import"./index-CFLhIysZ.js";import"./index-B0RCps1L.js";import"./index-kYhIjE44.js";import"./index-IzGGsCUm.js";import"./index-D2qS9a38.js";import"./index-C1JXx-aU.js";import"./index-Bsb9bHmP.js";const we={class:"p-4"},Ve={class:"flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4"},ke={class:"flex items-center gap-4"},De={class:"flex items-center gap-3"},Ce={class:"flex gap-2"},Ie={key:0,class:"flex justify-center py-12"},Se={key:1,class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},Ae={class:"lg:col-span-2 flex flex-col gap-6"},je={class:"h-[400px] w-full"},$e={class:"font-bold"},Fe={class:"flex gap-2"},ze={class:"flex flex-col gap-6"},Ee={class:"flex flex-col gap-2"},Me={class:"flex items-end gap-2"},Be={class:"text-4xl font-bold text-color"},Re={class:"text-lg text-color-secondary mb-1"},Le={class:"flex items-center gap-2 mt-2"},Te={class:"text-sm text-color-secondary"},qe={class:"flex flex-col gap-2"},Ne={class:"flex flex-col gap-2"},Ue={for:"value",class:"text-sm font-medium text-color-secondary"},He={class:"flex flex-col gap-2"},Oe={class:"flex flex-col gap-3 text-sm"},We={class:"flex justify-between"},Ge={class:"font-medium"},Pe={class:"flex justify-between"},Qe={class:"font-medium"},Ze={class:"flex justify-between"},Je={class:"font-medium"},Ke={class:"flex justify-between"},Xe={class:"font-medium text-right max-w-[60%]"},Ye={key:0,class:"mt-2 pt-2 border-t border-surface-border"},et={class:"text-color"},tt={key:1,class:"mt-2 pt-2 border-t border-surface-border"},st={class:"flex items-center gap-2"},at={class:"w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/20 flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold"},lt={class:"font-medium"},ot={class:"flex items-center gap-2 mb-2"},it={key:0,class:"flex flex-col gap-3"},nt=["onClick"],rt={class:"flex justify-between items-start mb-1"},dt={class:"font-medium text-color text-sm line-clamp-2"},ut={class:"flex justify-between items-center text-xs text-color-secondary"},ct={key:0},mt={key:1,class:"text-color-secondary text-sm italic"},pt={class:"flex flex-col gap-4 pt-4"},vt={class:"flex flex-col gap-2"},ft={class:"flex flex-col gap-2"},yt={class:"flex flex-col gap-2"},Mt=ie({__name:"IndicateurDetail",setup(xt){const C=ve(),I=ge(),x=_e(),L=ne(),v=re(),T=de(),S=V(!1),c=V({date:new Date,value:null,comment:""}),a=D(()=>x.currentIndicator),q=D(()=>x.loading),N=D(()=>a.value?.values&&a.value.values.length>0?a.value.values[0]:null),U=D(()=>{if(!a.value||!a.value.values)return{labels:[],datasets:[]};const t=[...a.value.values].sort((g,oe)=>new Date(g.date).getTime()-new Date(oe.date).getTime()),e=t.map(g=>g.date?new Date(g.date).toLocaleDateString():"-"),d=t.map(g=>g.value),o=a.value.target_value,f=[{label:"Valeur",data:d,fill:!0,borderColor:"#3B82F6",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.4,borderWidth:1}];o!=null&&f.push({label:"Cible",data:Array(e.length).fill(o),fill:!1,borderColor:"#10B981",borderDash:[5,5],tension:0,pointRadius:0,borderWidth:2});const j=a.value.threshold_min;j!=null&&f.push({label:"Seuil Min",data:Array(e.length).fill(j),fill:!1,borderColor:"#F97316",borderDash:[2,2],tension:0,pointRadius:0,borderWidth:1});const $=a.value.threshold_max;return $!=null&&f.push({label:"Seuil Max",data:Array(e.length).fill($),fill:!1,borderColor:"#EF4444",borderDash:[2,2],tension:0,pointRadius:0,borderWidth:1}),{labels:e,datasets:f}}),H={maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}},scales:{y:{beginAtZero:!0}}},O=async()=>{const t=C.params.id,e=Array.isArray(t)?t[0]:t;if(e){const d=parseInt(e);isNaN(d)||await x.fetchIndicatorById(d)}},W=async()=>{if(!c.value.value||!c.value.date){v.add({severity:"warn",summary:"Attention",detail:"Veuillez remplir la date et la valeur",life:3e3,icon:"exclamation-triangle"});return}S.value=!0;try{const t=C.params.id,e=Array.isArray(t)?t[0]:t;if(!e)throw new Error("ID de l'indicateur manquant");const d=parseInt(e);if(isNaN(d))throw new Error("ID de l'indicateur invalide");const o=c.value.date.toISOString().split("T")[0];await x.addIndicatorValue(d,{value:c.value.value,date:o,comment:c.value.comment}),v.add({severity:"success",summary:"Succès",detail:"Valeur ajoutée",life:3e3,icon:"check"}),c.value={date:new Date,value:null,comment:""}}catch(t){console.log(t),v.add({severity:"error",summary:"Erreur",detail:"Erreur lors de l'ajout",life:3e3,icon:"times"})}finally{S.value=!1}},w=V(!1),A=V(!1),m=V({id:0,date:new Date,value:null,comment:""}),G=t=>{m.value={id:t.id,date:new Date(t.date),value:t.value,comment:t.comment||""},w.value=!0},P=async()=>{if(m.value.value!==null){A.value=!0;try{const t=a.value?.id;if(!t)return;const e=m.value.date.toISOString().split("T")[0]??"";await x.updateIndicatorValue(t,m.value.id,{value:m.value.value,date:e,comment:m.value.comment}),v.add({severity:"success",summary:"Succès",detail:"Valeur mise à jour",life:3e3}),w.value=!1}catch{v.add({severity:"error",summary:"Erreur",detail:"Impossible de mettre à jour la valeur",life:3e3})}finally{A.value=!1}}},Q=t=>{T.require({message:"Voulez-vous vraiment supprimer cette valeur ?",header:"Confirmation",icon:"exclamation-triangle",acceptClass:"p-button-danger",accept:async()=>{try{if(!a.value?.id)return;await x.deleteIndicatorValue(a.value.id,t.id),v.add({severity:"success",summary:"Succès",detail:"Valeur supprimée",life:3e3})}catch{v.add({severity:"error",summary:"Erreur",detail:"Impossible de supprimer la valeur",life:3e3})}}})},Z=()=>I.back(),J=()=>I.push(`/indicators/${C.params.id}/edit`),F=t=>t?new Date(t).toLocaleDateString():"-",K=t=>t?{daily:"Quotidienne",weekly:"Hebdomadaire",monthly:"Mensuelle",quarterly:"Trimestrielle",yearly:"Annuelle"}[t]||t:"-",X=t=>t?{positive:"Hausse",negative:"Baisse",neutral:"Stable"}[t]||t:"Stable",Y=(t,e)=>!t||!e||t==="neutral"?"info":e==="maximize"?t==="positive"?"success":"danger":e==="minimize"?t==="positive"?"danger":"success":"info",ee=t=>t&&{positive:"arrow-trend-up",negative:"arrow-trend-down",neutral:"minus"}[t]||"minus",te=t=>t?{maximize:"Maximiser",minimize:"Minimiser",target:"Cibler"}[t]||t:"-",se=t=>t?{open:"Ouvert",in_progress:"En cours",completed:"Terminé",cancelled:"Annulé"}[t]||t:"-",ae=t=>t?{low:"Basse",medium:"Moyenne",high:"Haute",critical:"Critique"}[t]||t:"-",le=t=>t?{low:"info",medium:"warn",high:"danger",critical:"danger"}[t]||"info":"secondary";return ue(()=>{O()}),(t,e)=>{const d=me("font-awesome-icon");return u(),p("div",we,[s("div",Ve,[s("div",ke,[l(i(y),{text:"",rounded:"",severity:"secondary",onClick:Z},{icon:n(()=>[l(d,{icon:"arrow-left"})]),_:1}),s("div",null,[s("div",De,[s("h2",null,r(a.value?.name),1),a.value?.indicator_category?(u(),p("div",{key:0,class:"flex items-center gap-2 px-2 py-0.5 rounded text-xs font-medium text-white",style:ce({backgroundColor:a.value.indicator_category.color||"#64748B"})},[l(d,{icon:a.value.indicator_category.icon||"folder"},null,8,["icon"]),b(" "+r(a.value.indicator_category.name),1)],4)):_("",!0)])])]),s("div",Ce,[l(i(y),{label:"Modifier",severity:"secondary",outlined:"",onClick:J},{icon:n(()=>[l(d,{icon:"pencil",class:"mr-2"})]),_:1})])]),q.value?(u(),p("div",Ie,[l(d,{icon:["fas","spinner"],spin:"",size:"2x",class:"text-color-secondary"})])):a.value?(u(),p("div",Se,[s("div",Ae,[l(i(h),null,{title:n(()=>[...e[8]||(e[8]=[b("Évolution",-1)])]),content:n(()=>[s("div",je,[(u(),z(i(be),{type:"line",data:U.value,options:H,class:"h-full",key:a.value.id},null,8,["data"]))])]),_:1}),l(i(h),null,{title:n(()=>[...e[9]||(e[9]=[b("Historique des valeurs",-1)])]),content:n(()=>[l(i(he),{value:a.value.values,paginator:"",rows:5,size:"small",stripedRows:""},{default:n(()=>[l(i(k),{field:"date",header:"Date"},{body:n(o=>[b(r(F(o.data.date)),1)]),_:1}),l(i(k),{field:"value",header:"Valeur"},{body:n(o=>[s("span",$e,r(o.data.value)+" "+r(a.value.unit),1)]),_:1}),l(i(k),{field:"comment",header:"Commentaire"}),l(i(k),{field:"creator.username",header:"Saisi par"}),i(L).userRole==="admin"?(u(),z(i(k),{key:0,header:"Actions",style:{width:"100px"}},{body:n(o=>[s("div",Fe,[l(i(y),{icon:"pi pi-pencil",text:"",rounded:"",severity:"secondary",size:"small",onClick:f=>G(o.data)},{icon:n(()=>[l(d,{icon:"pencil"})]),_:1},8,["onClick"]),l(i(y),{icon:"pi pi-trash",text:"",rounded:"",severity:"danger",size:"small",onClick:f=>Q(o.data)},{icon:n(()=>[l(d,{icon:"trash"})]),_:1},8,["onClick"])])]),_:1})):_("",!0)]),_:1},8,["value"])]),_:1})]),s("div",ze,[l(i(h),null,{content:n(()=>[s("div",Ee,[e[10]||(e[10]=s("span",{class:"text-sm text-color-secondary"},"Dernière valeur",-1)),s("div",Me,[s("span",Be,r(N.value?.value??"-"),1),s("span",Re,r(a.value.unit),1)]),s("div",Le,[l(i(E),{severity:Y(a.value.trend_direction,a.value.goal_type),value:X(a.value.trend_direction)},{icon:n(()=>[l(d,{icon:ee(a.value.trend_direction),class:"mr-2"},null,8,["icon"])]),_:1},8,["severity","value"]),s("span",Te,"Cible: "+r(a.value.target_value)+" "+r(a.value.unit),1)])])]),_:1}),l(i(h),null,{title:n(()=>[...e[11]||(e[11]=[b("Ajouter une valeur",-1)])]),content:n(()=>[s("form",{onSubmit:fe(W,["prevent"]),class:"flex flex-col gap-4"},[s("div",qe,[e[12]||(e[12]=s("label",{for:"date",class:"text-sm font-medium text-color-secondary"},"Date",-1)),l(i(R),{modelValue:c.value.date,"onUpdate:modelValue":e[0]||(e[0]=o=>c.value.date=o),dateFormat:"dd/mm/yy",showIcon:"",fluid:"",inputId:"date"},null,8,["modelValue"])]),s("div",Ne,[s("label",Ue,"Valeur ("+r(a.value.unit)+")",1),l(i(M),{modelValue:c.value.value,"onUpdate:modelValue":e[1]||(e[1]=o=>c.value.value=o),minFractionDigits:0,maxFractionDigits:2,inputId:"value",fluid:""},null,8,["modelValue"])]),s("div",He,[e[13]||(e[13]=s("label",{for:"comment",class:"text-sm font-medium text-color-secondary"},"Commentaire",-1)),l(i(B),{modelValue:c.value.comment,"onUpdate:modelValue":e[2]||(e[2]=o=>c.value.comment=o),rows:"3",autoResize:""},null,8,["modelValue"])]),l(i(y),{type:"submit",label:"Ajouter",loading:S.value},{icon:n(()=>[l(d,{icon:"plus",class:"mr-2"})]),_:1},8,["loading"])],32)]),_:1}),l(i(h),null,{title:n(()=>[...e[14]||(e[14]=[b("Détails",-1)])]),content:n(()=>[s("div",Oe,[s("div",We,[e[15]||(e[15]=s("span",{class:"text-color-secondary"},"Fréquence",-1)),s("span",Ge,r(K(a.value.frequency)),1)]),s("div",Pe,[e[16]||(e[16]=s("span",{class:"text-color-secondary"},"Objectif",-1)),s("span",Qe,r(te(a.value.goal_type)),1)]),s("div",Ze,[e[17]||(e[17]=s("span",{class:"text-color-secondary"},"Source",-1)),s("span",Je,r(a.value.data_source||"-"),1)]),s("div",Ke,[e[18]||(e[18]=s("span",{class:"text-color-secondary"},"Méthode de calcul",-1)),s("span",Xe,r(a.value.calculation_method||"-"),1)]),a.value.description?(u(),p("div",Ye,[e[19]||(e[19]=s("span",{class:"text-color-secondary block mb-1"},"Description",-1)),s("p",et,r(a.value.description),1)])):_("",!0),a.value.manager?(u(),p("div",tt,[e[20]||(e[20]=s("span",{class:"text-color-secondary block mb-1"},"Responsable",-1)),s("div",st,[s("div",at,r(a.value.manager.first_name[0])+r(a.value.manager.last_name[0]),1),s("span",lt,r(a.value.manager.first_name)+" "+r(a.value.manager.last_name),1)])])):_("",!0)])]),_:1}),l(i(h),null,{title:n(()=>[s("div",ot,[l(d,{icon:"tasks"}),e[21]||(e[21]=s("span",null,"Actions Liées",-1))])]),content:n(()=>[a.value.actions&&a.value.actions.length>0?(u(),p("div",it,[(u(!0),p(ye,null,xe(a.value.actions,o=>(u(),p("div",{key:o.id,class:"p-3 border rounded-lg hover:bg-surface-50 cursor-pointer transition-colors",onClick:f=>i(I).push(`/actions/${o.id}`)},[s("div",rt,[s("span",dt,r(o.title),1),l(i(E),{severity:le(o.priority),class:"text-xs",value:ae(o.priority).charAt(0)},null,8,["severity","value"])]),s("div",ut,[s("span",null,r(se(o.status)),1),o.due_date?(u(),p("span",ct,r(F(o.due_date)),1)):_("",!0)])],8,nt))),128))])):(u(),p("div",mt,"Aucune action liée."))]),_:1})])])):_("",!0),l(i(pe),{visible:w.value,"onUpdate:visible":e[7]||(e[7]=o=>w.value=o),header:"Modifier la valeur",style:{width:"450px"},modal:""},{footer:n(()=>[l(i(y),{label:"Annuler",text:"",onClick:e[6]||(e[6]=o=>w.value=!1),severity:"secondary"},{icon:n(()=>[l(d,{icon:"times",class:"mr-2"})]),_:1}),l(i(y),{label:"Enregistrer",onClick:P,loading:A.value},{icon:n(()=>[l(d,{icon:"check",class:"mr-2"})]),_:1},8,["loading"])]),default:n(()=>[s("div",pt,[s("div",vt,[e[22]||(e[22]=s("label",{for:"edit-date",class:"text-sm font-medium text-color-secondary"},"Date",-1)),l(i(R),{modelValue:m.value.date,"onUpdate:modelValue":e[3]||(e[3]=o=>m.value.date=o),dateFormat:"dd/mm/yy",showIcon:"",fluid:"",inputId:"edit-date"},null,8,["modelValue"])]),s("div",ft,[e[23]||(e[23]=s("label",{for:"edit-value",class:"text-sm font-medium text-color-secondary"},"Valeur",-1)),l(i(M),{modelValue:m.value.value,"onUpdate:modelValue":e[4]||(e[4]=o=>m.value.value=o),minFractionDigits:0,maxFractionDigits:2,inputId:"edit-value",fluid:""},null,8,["modelValue"])]),s("div",yt,[e[24]||(e[24]=s("label",{for:"edit-comment",class:"text-sm font-medium text-color-secondary"},"Commentaire",-1)),l(i(B),{modelValue:m.value.comment,"onUpdate:modelValue":e[5]||(e[5]=o=>m.value.comment=o),rows:"3",autoResize:"",id:"edit-comment"},null,8,["modelValue"])])])]),_:1},8,["visible"])])}}});export{Mt as default};
