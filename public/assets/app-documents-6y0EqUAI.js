import{u as le,j as X,g as K,n as ae,A as be,a as C,b as pe,c as we,T as ie,q as ve,r as U,h as H,l as ke,m as $e,B as de,C as ue,s as De,f as Ce,D as Se}from"./vendor-primevue-_kQtzldN.js";import{d as J,r as j,c as R,o as Z,b as k,F as ne,i as t,u as n,l as r,f as e,j as W,t as g,v as P,h as V,e as me,g as E,m as c,w as fe,n as Y,p as ye,k as re,s as te,x as _e,q as Ve}from"./vendor-vue-7xZ5dmFb.js";import{u as ge,_ as ce,a as se,b as xe,c as ee,d as je}from"./app-actions-MIoyI-E5.js";import{d as Te}from"./vendor-pinia--L0FGc_G.js";const Fe={class:"flex justify-between items-center px-4 py-2"},Ie={class:"flex gap-1"},Ee={class:"overflow-y-auto h-[calc(100vh-16rem)]"},ze={class:"flex items-center justify-between w-full group"},Le={class:"flex items-center gap-2"},Ae={class:"text-color"},Be={class:"hidden group-hover:flex gap-1"},Me={class:"field"},Ne={class:"field mt-4"},Re=J({__name:"DocumentFolderSidebar",emits:["select","unselect"],setup(L,{emit:$}){const v=$,b=ge(),f=le(),S=X(),u=j(null),y=j(!1),a=j(null),l=j({name:"",parent_id:null}),s=R(()=>{const m=o=>({key:o.id.toString(),label:o.name,data:o,children:o.children&&o.children.length>0?o.children.map(m):void 0,leaf:!o.children||o.children.length===0});return b.folders.map(o=>m(o))}),D=R(()=>{const m=o=>{if(a.value&&o.id===a.value.id)return null;const T=o.children?o.children.map(m).filter(z=>z!==null):[];return{key:o.id.toString(),label:o.name,data:o.id,children:T,selectable:!0}};return b.folders.map(m).filter(o=>o!==null)}),B=m=>{v("select",m.data)},F=()=>{v("unselect")},x=()=>{u.value=null,v("unselect")},i=m=>{m?(a.value=m,l.value={name:m.name,parent_id:m.parent_id?{[m.parent_id.toString()]:!0}:null}):(a.value=null,l.value={name:"",parent_id:u.value&&Object.keys(u.value).length>0?{[Object.keys(u.value)[0]]:!0}:null}),y.value=!0},A=()=>{y.value=!1,a.value=null},M=async()=>{try{let m=null;if(l.value.parent_id){const o=Object.keys(l.value.parent_id);o.length>0&&(m=parseInt(o[0]))}a.value?(await b.updateFolder(a.value.id,{name:l.value.name,parent_id:m}),S.add({severity:"success",summary:"Succès",detail:"Dossier mis à jour",life:3e3})):(await b.createFolder({name:l.value.name,parent_id:m}),S.add({severity:"success",summary:"Succès",detail:"Dossier créé",life:3e3})),A()}catch(m){console.log(m),S.add({severity:"error",summary:"Erreur",detail:"Une erreur est survenue",life:3e3})}},G=m=>{f.require({message:`Voulez-vous vraiment supprimer le dossier "${m.name}" ?`,header:"Confirmation",icon:"exclamation-triangle",accept:async()=>{try{await b.deleteFolder(m.id),S.add({severity:"success",summary:"Succès",detail:"Dossier supprimé",life:3e3,icon:"check"}),u.value&&u.value[m.id.toString()]&&(u.value=null,v("unselect"))}catch(o){console.log(o),S.add({severity:"error",summary:"Erreur",detail:"Impossible de supprimer le dossier",life:3e3,icon:"times"})}}})};return Z(()=>{b.fetchFolders()}),(m,o)=>{const T=W("font-awesome-icon"),z=ie;return c(),k(ne,null,[t(n(K),{class:"h-full"},{title:r(()=>[e("div",Fe,[o[6]||(o[6]=e("h4",{class:"text-color m-0"},"Dossiers",-1)),e("div",Ie,[u.value?P((c(),V(n(C),{key:0,text:"",rounded:"",size:"small",onClick:o[0]||(o[0]=I=>x())},{icon:r(()=>[t(T,{icon:"rotate-left"})]),_:1})),[[z,"Tout afficher"]]):E("",!0),P((c(),V(n(C),{text:"",rounded:"",size:"small",onClick:o[1]||(o[1]=I=>i())},{icon:r(()=>[t(T,{icon:"plus"})]),_:1})),[[z,"Nouveau dossier"]])])])]),content:r(()=>[e("div",Ee,[t(n(be),{value:s.value,selectionMode:"single",selectionKeys:u.value,"onUpdate:selectionKeys":o[2]||(o[2]=I=>u.value=I),onNodeSelect:B,onNodeUnselect:F,class:"w-full border-none p-0"},{default:r(I=>[e("div",ze,[e("span",Le,[t(T,{icon:"folder",class:"text-primary-500 dark:text-primary-400"}),e("span",Ae,g(I.node.label),1)]),e("div",Be,[P((c(),V(n(C),{text:"",rounded:"",severity:"secondary",size:"small",class:"w-6 h-6",onClick:me(w=>i(I.node.data),["stop"])},{icon:r(()=>[t(T,{icon:"pen",class:"text-xs"})]),_:1},8,["onClick"])),[[z,"Modifier le dossier",void 0,{top:!0}]]),P((c(),V(n(C),{text:"",rounded:"",severity:"danger",size:"small",class:"w-6 h-6",onClick:me(w=>G(I.node.data),["stop"])},{icon:r(()=>[t(T,{icon:"trash",class:"text-xs"})]),_:1},8,["onClick"])),[[z,"Supprimer le dossier",void 0,{top:!0}]])])])]),_:1},8,["value","selectionKeys"])])]),_:1}),t(n(ae),{visible:y.value,"onUpdate:visible":o[5]||(o[5]=I=>y.value=I),header:a.value?"Modifier le dossier":"Nouveau dossier",modal:!0,class:"p-fluid"},{footer:r(()=>[t(n(C),{label:"Annuler",text:"",severity:"secondary",onClick:A},{icon:r(()=>[t(T,{icon:"times",class:"mr-2"})]),_:1}),t(n(C),{label:"Enregistrer",onClick:M},{icon:r(()=>[t(T,{icon:"check",class:"mr-2"})]),_:1})]),default:r(()=>[e("div",Me,[o[7]||(o[7]=e("label",{for:"folderName"},"Nom",-1)),t(n(pe),{id:"folderName",modelValue:l.value.name,"onUpdate:modelValue":o[3]||(o[3]=I=>l.value.name=I),required:"",autofocus:""},null,8,["modelValue"])]),e("div",Ne,[o[8]||(o[8]=e("label",{for:"parentFolder"},"Dossier parent",-1)),t(n(we),{modelValue:l.value.parent_id,"onUpdate:modelValue":o[4]||(o[4]=I=>l.value.parent_id=I),options:D.value,showClear:"",placeholder:"Sélectionnez un parent (ou laisser vide pour la racine)"},null,8,["modelValue","options"])])]),_:1},8,["visible","header"])],64)}}}),Ue=ce(Re,[["__scopeId","data-v-65881118"]]),Pe={class:"p-4 h-[calc(100vh-6rem)] flex flex-col"},qe={class:"flex justify-between items-center mb-2"},Oe={class:"flex gap-2"},He={class:"flex flex-1 gap-4 overflow-hidden"},Ke={class:"w-1/4 flex flex-col"},Ge={class:"flex-1 flex flex-col overflow-hidden"},Qe={class:"flex flex-wrap gap-2 items-center justify-between px-4 py-2"},Je={class:"flex items-center gap-2"},We={class:"flex flex-col"},Xe={class:"font-medium text-color"},Ye={class:"text-xs text-color-secondary"},Ze={key:1,class:"text-color-secondary"},et={class:"bg-surface-100 dark:bg-surface-700 text-color-secondary px-2 py-1 rounded text-xs"},tt={class:"text-color-secondary"},st={class:"flex gap-1"},ot=J({__name:"DocumentIndex",setup(L){const $=te(),v=se(),b=ge(),f=le(),S=X(),u=j(""),y=j(10),a=j(0),l=j(null),s=R(()=>v.documents),D=R(()=>v.loading||b.loading),B=R(()=>v.pagination.total),F=async()=>{const h={search:u.value};l.value&&(h.document_folder_id=l.value.id),await v.fetchDocuments(a.value+1,y.value,h)},x=h=>{a.value=h.page,y.value=h.rows,F()},i=h=>{l.value=h,a.value=0,F()},A=()=>{l.value=null,a.value=0,F()},M=()=>{$.push({path:"/documents/create",query:l.value?{document_folder_id:l.value.id}:{}})},G=h=>{$.push(`/documents/${h}`)},m=h=>{$.push(`/documents/${h}/edit`)},o=h=>{f.require({message:`Voulez-vous vraiment supprimer le document "${h.title}" ?`,header:"Confirmation de suppression",icon:"exclamation-triangle",rejectLabel:"Annuler",acceptLabel:"Supprimer",acceptClass:"p-button-danger",rejectClass:"p-button-secondary",accept:async()=>{try{await v.deleteDocument(h.id),S.add({severity:"success",summary:"Succès",detail:"Document supprimé",life:3e3,icon:"check"}),F()}catch{S.add({severity:"error",summary:"Erreur",detail:"Impossible de supprimer le document",life:3e3,icon:"times"})}}})},T=async h=>{try{S.add({severity:"info",summary:"Téléchargement",detail:"Le téléchargement a commencé...",life:3e3}),await v.downloadDocument(h.id,h.filename)}catch{S.add({severity:"error",summary:"Erreur",detail:"Erreur lors du téléchargement",life:3e3})}},z=h=>{if(!h)return"file";switch((h||"").split(".").pop()?.toLowerCase()){case"pdf":return"file-pdf";case"doc":case"docx":return"file-word";case"xls":case"xlsx":return"file-excel";case"jpg":case"png":case"jpeg":return"image";default:return"file"}},I=h=>{if(!h)return"text-color-secondary";switch((h||"").split(".").pop()?.toLowerCase()){case"pdf":return"text-red-500";case"doc":case"docx":return"text-blue-500";case"xls":case"xlsx":return"text-green-500";case"jpg":case"png":case"jpeg":return"text-primary";default:return"text-color-secondary"}},w=h=>({draft:"Brouillon",pending_approval:"En attente",approved:"Approuvé",rejected:"Rejeté",archived:"Archivé"})[h]||h,Q=h=>({draft:"secondary",pending_approval:"warn",approved:"success",rejected:"danger",archived:"contrast"})[h]||"secondary",oe=h=>h?new Date(h).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}):"-";return fe(u,()=>{a.value=0,F()}),Z(async()=>{await F()}),(h,N)=>{const p=W("font-awesome-icon"),d=ie;return c(),k("div",Pe,[e("div",qe,[N[1]||(N[1]=e("h2",null,"Documents QHSE",-1)),e("div",Oe,[t(n(C),{label:"Nouveau document",onClick:M,severity:"primary"},{icon:r(()=>[t(p,{icon:"plus",class:"mr-2"})]),_:1})])]),e("div",He,[e("div",Ke,[t(Ue,{onSelect:i,onUnselect:A})]),e("div",Ge,[t(n(K),{class:"h-full flex flex-col"},{title:r(()=>[e("div",Qe,[e("h4",null,g(l.value?l.value.name:"Tous les documents"),1),t(n(ke),{iconPosition:"left"},{default:r(()=>[t(n($e),null,{default:r(()=>[t(p,{icon:"magnifying-glass"})]),_:1}),t(n(pe),{modelValue:u.value,"onUpdate:modelValue":N[0]||(N[0]=_=>u.value=_),placeholder:"Rechercher...",size:"small"},null,8,["modelValue"])]),_:1})])]),content:r(()=>[t(n(ve),{ref:"dt",value:s.value,lazy:"",paginator:!0,rows:y.value,totalRecords:B.value,loading:D.value,onPage:x,paginatorTemplate:"FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown",rowsPerPageOptions:[10,25,50],currentPageReportTemplate:"{first} - {last} / {totalRecords}",class:"p-datatable-sm",scrollable:"",scrollHeight:"flex"},{empty:r(()=>[...N[2]||(N[2]=[re(" Aucun document trouvé. ",-1)])]),default:r(()=>[t(n(U),{field:"title",header:"Nom",sortable:"",style:{"min-width":"200px"}},{body:r(({data:_})=>[e("div",Je,[t(p,{icon:z(_.filename),class:Y(["text-xl",I(_.filename)])},null,8,["icon","class"]),e("div",We,[e("span",Xe,g(_.title),1),e("span",Ye,g(_.filename),1)])])]),_:1}),t(n(U),{field:"category",header:"Type",sortable:"",style:{width:"120px"}},{body:r(({data:_})=>[_.category?(c(),V(n(H),{key:0,value:_.category.name,style:ye({backgroundColor:_.category.color||"var(--surface-500)",color:"#fff"})},{icon:r(()=>[_.category.icon?(c(),V(p,{key:0,icon:["fas",_.category.icon],class:"mr-1"},null,8,["icon"])):E("",!0)]),_:2},1032,["value","style"])):(c(),k("span",Ze,"Non défini"))]),_:1}),t(n(U),{field:"version",header:"Ver.",style:{width:"80px"}},{body:r(({data:_})=>[e("span",et,g(_.version),1)]),_:1}),t(n(U),{field:"status",header:"Statut",style:{width:"100px"}},{body:r(({data:_})=>[t(n(H),{value:w(_.status),severity:Q(_.status)},null,8,["value","severity"])]),_:1}),t(n(U),{field:"updated_at",header:"Modifié le",style:{width:"120px"}},{body:r(({data:_})=>[e("span",tt,g(oe(_.updated_at)),1)]),_:1}),t(n(U),{header:"Actions",exportable:!1,style:{width:"100px"}},{body:r(({data:_})=>[e("div",st,[P((c(),V(n(C),{text:"",rounded:"",severity:"secondary",size:"small",onClick:O=>T(_)},{icon:r(()=>[t(p,{icon:"download"})]),_:1},8,["onClick"])),[[d,"Télécharger",void 0,{top:!0}]]),P((c(),V(n(C),{text:"",rounded:"",severity:"info",size:"small",onClick:O=>G(_.id)},{icon:r(()=>[t(p,{icon:"eye"})]),_:1},8,["onClick"])),[[d,"Voir",void 0,{top:!0}]]),P((c(),V(n(C),{text:"",rounded:"",severity:"success",size:"small",onClick:O=>m(_.id)},{icon:r(()=>[t(p,{icon:"pen"})]),_:1},8,["onClick"])),[[d,"Modifier",void 0,{top:!0}]]),P((c(),V(n(C),{text:"",rounded:"",severity:"danger",size:"small",onClick:O=>o(_)},{icon:r(()=>[t(p,{icon:"trash"})]),_:1},8,["onClick"])),[[d,"Supprimer",void 0,{top:!0}]])])]),_:1})]),_:1},8,["value","rows","totalRecords","loading"])]),_:1})])])])}}}),nt=ce(ot,[["__scopeId","data-v-58bbdf5e"]]),Ys=Object.freeze(Object.defineProperty({__proto__:null,default:nt},Symbol.toStringTag,{value:"Module"})),rt={class:"p-4"},lt={class:"flex flex-col md:flex-row md:items-center md:justify-between mb-2 gap-4"},at={class:"flex items-center gap-4"},it=J({__name:"DocumentCreate",setup(L){const $=te(),v=se(),b=X(),f=j(!1),S=async a=>{f.value=!0;try{const l=new FormData;if(l.append("title",a.title),l.append("description",a.description??""),a.document_folder_id&&l.append("document_folder_id",a.document_folder_id.toString()),a.category_id&&l.append("category_id",a.category_id.toString()),l.append("version",a.version),l.append("status",a.status),a.expires_date){const D=new Date(a.expires_date).toISOString().split("T")[0];l.append("expires_date",D??"")}a.file&&l.append("file",a.file),await v.createDocument(l),b.add({severity:"success",summary:"Succès",detail:"Document créé avec succès",life:3e3,icon:"check"}),$.push("/documents")}catch(l){console.error("Erreur lors de la création du document:",l),b.add({severity:"error",summary:"Erreur",detail:"Impossible de créer le document",life:3e3,icon:"times"})}finally{f.value=!1}},u=()=>{$.push("/documents")},y=()=>{$.back()};return(a,l)=>{const s=W("font-awesome-icon");return c(),k("div",rt,[e("div",lt,[e("div",at,[t(n(C),{text:"",rounded:"",severity:"secondary",onClick:y},{icon:r(()=>[t(s,{icon:"arrow-left"})]),_:1}),l[0]||(l[0]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("h2",{class:"text-color"},"Créer un nouveau document")])],-1))])]),t(n(K),null,{content:r(()=>[t(xe,{submitButtonText:"Enregistrer",loading:f.value,onSubmit:S,onCancel:u},null,8,["loading"])]),_:1})])}}}),Zs=Object.freeze(Object.defineProperty({__proto__:null,default:it},Symbol.toStringTag,{value:"Module"})),he=Te("documentVersions",()=>{const L=j([]),$=j(!1),v=j(null);return{versions:L,loading:$,error:v,fetchVersions:async(y,a=!1)=>{$.value=!0,v.value=null;try{const{get:l}=ee(),D=await l(`/documents/${y}/versions${a?"?with_archived=true":""}`);D.success&&D.data?L.value=D.data:v.value=D.error||"Impossible de charger les versions"}catch(l){console.error("Error fetching versions:",l),v.value="Impossible de charger les versions"}finally{$.value=!1}},createVersion:async(y,a)=>{$.value=!0,v.value=null;try{const{post:l}=ee(),s=await l(`/documents/${y}/versions`,a);if(s.success&&s.data)return L.value.unshift(s.data.version),s.data;throw v.value=s.error||"Impossible de créer la version",new Error(v.value)}catch(l){throw console.error("Error creating version:",l),v.value="Impossible de créer la version",l}finally{$.value=!1}},downloadVersion:async y=>{try{const{get:a}=ee(),l=await a(`/versions/${y}/download`,{responseType:"blob"});if(l.success&&l.data){const s=window.URL.createObjectURL(l.data),D=document.createElement("a");D.href=s;const B=L.value.find(F=>F.id===y);D.download=B?.filename||"document",document.body.appendChild(D),D.click(),document.body.removeChild(D),window.URL.revokeObjectURL(s)}}catch(a){throw console.error("Error downloading version:",a),v.value="Impossible de télécharger la version",a}},restoreVersion:async y=>{$.value=!0,v.value=null;try{const{post:a}=ee(),l=await a(`/versions/${y}/restore`,{});if(l.success&&l.data)return L.value.unshift(l.data.version),l.data;throw v.value=l.error||"Impossible de restaurer la version",new Error(v.value)}catch(a){throw console.error("Error restoring version:",a),v.value="Impossible de restaurer la version",a}finally{$.value=!1}}}}),ct={class:"flex justify-between items-center mb-4"},dt={class:"flex items-center gap-4"},ut={class:"flex items-center gap-2"},mt={class:"flex justify-between items-center mb-2"},pt={class:"flex items-center gap-2"},vt={class:"flex items-center gap-2"},ft={class:"flex items-center gap-2"},yt={key:0,class:"flex justify-center py-8"},_t={key:1,class:"text-center py-8 text-red-500"},gt={key:2,class:"text-center py-8 text-color-secondary"},xt={class:"flex items-center gap-2"},ht={class:"text-color"},bt={key:0,class:"flex items-center gap-2"},wt={class:"text-color"},kt={key:1,class:"text-color-secondary"},$t={class:"max-w-md"},Dt={class:"text-sm text-color line-clamp-2"},Ct={class:"text-sm text-color-secondary"},St={class:"flex gap-1"},Vt={key:0,class:"py-4"},jt={class:"mb-4"},Tt={class:"ml-2 font-medium text-color"},Ft={class:"mb-4"},It={class:"ml-2 font-medium text-color"},Et={class:"text-color whitespace-pre-wrap"},zt=J({__name:"DocumentVersionHistory",props:{documentId:{},currentVersion:{}},emits:["restore"],setup(L,{emit:$}){const v=L,b=$,f=he(),S=X(),u=R(()=>f.versions),y=R(()=>f.loading),a=R(()=>f.error),l=j(!1),s=j(null),D=j(!1),B=()=>{f.fetchVersions(v.documentId,D.value)},F=m=>m.version===v.currentVersion,x=m=>new Date(m).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),i=m=>{if(m===0)return"0 B";const o=1024,T=["B","KB","MB","GB"],z=Math.floor(Math.log(m)/Math.log(o));return Math.round(m/Math.pow(o,z)*100)/100+" "+T[z]},A=m=>{s.value=m,l.value=!0},M=async m=>{try{await f.downloadVersion(m.id),S.add({severity:"success",summary:"Succès",detail:`Version ${m.version} téléchargée`,life:3e3})}catch{S.add({severity:"error",summary:"Erreur",detail:"Impossible de télécharger la version",life:3e3})}},G=m=>{b("restore",m)};return Z(()=>{f.fetchVersions(v.documentId)}),(m,o)=>{const T=W("font-awesome-icon"),z=K,I=ie;return c(),V(z,null,{title:r(()=>[e("div",mt,[e("div",pt,[t(T,{icon:"clock-rotate-left"}),o[6]||(o[6]=e("span",null,"Historique des versions",-1))]),e("div",vt,[e("div",ft,[t(n(de),{modelValue:D.value,"onUpdate:modelValue":o[1]||(o[1]=w=>D.value=w),onChange:B,inputId:"showArchived"},null,8,["modelValue"]),o[7]||(o[7]=e("label",{for:"showArchived",class:"text-sm cursor-pointer"},"Afficher archives",-1))]),t(n(H),{value:`${u.value.length} version${u.value.length>1?"s":""}`,severity:"info"},null,8,["value"])])])]),content:r(()=>[y.value?(c(),k("div",yt,[t(T,{icon:"spinner",spin:"",size:"2x",class:"text-color-secondary"})])):a.value?(c(),k("div",_t,[e("p",null,g(a.value),1)])):u.value.length===0?(c(),k("div",gt,[t(T,{icon:"inbox",size:"3x",class:"mb-3"}),o[8]||(o[8]=e("p",null,"Aucune version enregistrée",-1))])):(c(),V(n(ve),{key:3,value:u.value,class:"p-datatable-sm",stripedRows:""},{default:r(()=>[t(n(U),{header:"Version",style:{width:"100px"}},{body:r(({data:w})=>[e("div",xt,[t(n(H),{value:w.version,severity:F(w)?"success":"secondary"},null,8,["value","severity"]),F(w)?(c(),V(n(H),{key:0,value:"Actuelle",severity:"success",size:"small"})):E("",!0)])]),_:1}),t(n(U),{header:"Date",style:{width:"150px"}},{body:r(({data:w})=>[e("span",ht,g(x(w.created_at)),1)]),_:1}),t(n(U),{header:"Créateur",style:{width:"180px"}},{body:r(({data:w})=>[w.creator?(c(),k("div",bt,[t(T,{icon:"user",class:"text-color-secondary"}),e("span",wt,g(w.creator.first_name)+" "+g(w.creator.last_name),1)])):(c(),k("span",kt,"-"))]),_:1}),t(n(U),{header:"Changelog"},{body:r(({data:w})=>[e("div",$t,[e("p",Dt,g(w.changelog),1)])]),_:1}),t(n(U),{header:"Taille",style:{width:"100px"}},{body:r(({data:w})=>[e("span",Ct,g(i(w.file_size)),1)]),_:1}),t(n(U),{header:"Actions",style:{width:"120px"}},{body:r(({data:w})=>[e("div",St,[P((c(),V(n(C),{text:"",rounded:"",severity:"secondary",size:"small",onClick:Q=>A(w)},{icon:r(()=>[t(T,{icon:"info-circle"})]),_:1},8,["onClick"])),[[I,"Voir changelog",void 0,{top:!0}]]),P((c(),V(n(C),{text:"",rounded:"",severity:"info",size:"small",onClick:Q=>M(w)},{icon:r(()=>[t(T,{icon:"download"})]),_:1},8,["onClick"])),[[I,"Télécharger",void 0,{top:!0}]]),F(w)?E("",!0):P((c(),V(n(C),{key:0,text:"",rounded:"",severity:"warning",size:"small",onClick:Q=>G(w)},{icon:r(()=>[t(T,{icon:"clock-rotate-left"})]),_:1},8,["onClick"])),[[I,"Restaurer cette version",void 0,{top:!0}]])])]),_:1})]),_:1},8,["value"])),t(n(ae),{visible:l.value,"onUpdate:visible":o[3]||(o[3]=w=>l.value=w),header:`Changelog - Version ${s.value?.version}`,modal:!0,style:{width:"600px"}},{footer:r(()=>[t(n(C),{label:"Fermer",text:"",onClick:o[2]||(o[2]=w=>l.value=!1)})]),default:r(()=>[s.value?(c(),k("div",Vt,[e("div",jt,[o[9]||(o[9]=e("span",{class:"text-sm text-color-secondary"},"Date :",-1)),e("span",Tt,g(x(s.value.created_at)),1)]),e("div",Ft,[o[10]||(o[10]=e("span",{class:"text-sm text-color-secondary"},"Créateur :",-1)),e("span",It,g(s.value.creator?.first_name)+" "+g(s.value.creator?.last_name),1)]),e("div",null,[o[11]||(o[11]=e("span",{class:"text-sm text-color-secondary block mb-2"},"Description des changements :",-1)),e("p",Et,g(s.value.changelog),1)])])):E("",!0)]),_:1},8,["visible","header"])]),default:r(()=>[e("div",ct,[o[5]||(o[5]=e("h3",{class:"text-lg font-semibold"},"Historique des versions",-1)),e("div",dt,[e("div",ut,[t(n(de),{modelValue:D.value,"onUpdate:modelValue":o[0]||(o[0]=w=>D.value=w),onChange:B,inputId:"showArchived"},null,8,["modelValue"]),o[4]||(o[4]=e("label",{for:"showArchived",class:"text-sm cursor-pointer"},"Afficher archives",-1))]),t(n(H),{value:`${u.value.length} version${u.value.length>1?"s":""}`,severity:"info"},null,8,["value"])])])]),_:1})}}}),Lt=ce(zt,[["__scopeId","data-v-96c93efd"]]),At={class:"flex flex-col gap-4 py-4"},Bt={class:"bg-blue-50 border border-blue-200 rounded p-4"},Mt={class:"flex items-center gap-2 mb-2"},Nt={class:"text-sm text-blue-800"},Rt={class:"field"},Ut={class:"flex gap-4"},Pt={class:"flex items-center"},qt={class:"flex items-center"},Ot={key:0,class:"text-red-500"},Ht={class:"field"},Kt={key:0,class:"text-color-secondary block mt-1"},Gt={key:1,class:"text-red-500 block mt-1"},Qt={class:"field"},Jt={class:"text-color-secondary"},Wt={key:0,class:"text-red-500 block"},Xt=J({__name:"UploadNewVersionDialog",props:{visible:{type:Boolean},currentVersion:{},loading:{type:Boolean,default:!1}},emits:["update:visible","upload"],setup(L,{emit:$}){const v=L,b=$,f=j({versionType:"minor",file:null,changelog:""}),S=j(""),u=j({}),y=R(()=>{if(!v.currentVersion)return"1.0";const x=v.currentVersion.split("."),i=parseInt(x[0]||"1"),A=parseInt(x[1]||"0");return f.value.versionType==="major"?`${i+1}.0`:`${i}.${A+1}`}),a=R(()=>f.value.file!==null&&f.value.changelog.length>=10&&f.value.versionType!==""),l=x=>{const i=x.files;i&&i.length>0&&(f.value.file=i[0],S.value=i[0].name,u.value.file="")},s=()=>(u.value={},f.value.file||(u.value.file="Le fichier est requis"),f.value.changelog.length<10&&(u.value.changelog="Le changelog doit contenir au moins 10 caractères"),f.value.versionType||(u.value.versionType="Le type de version est requis"),Object.keys(u.value).length===0),D=()=>{s()&&f.value.file&&b("upload",{file:f.value.file,changelog:f.value.changelog,versionType:f.value.versionType})},B=()=>{b("update:visible",!1),F()},F=()=>{f.value={versionType:"minor",file:null,changelog:""},S.value="",u.value={}};return fe(()=>v.visible,x=>{x||F()}),(x,i)=>{const A=W("font-awesome-icon");return c(),V(n(ae),{visible:L.visible,"onUpdate:visible":B,header:"Nouvelle version du document",modal:!0,style:{width:"600px"}},{footer:r(()=>[t(n(C),{label:"Annuler",text:"",severity:"secondary",onClick:B}),t(n(C),{label:"Créer la version",onClick:D,loading:L.loading,disabled:!a.value},{icon:r(()=>[t(A,{icon:"upload",class:"mr-2"})]),_:1},8,["loading","disabled"])]),default:r(()=>[e("div",At,[e("div",Bt,[e("div",Mt,[t(A,{icon:"info-circle",class:"text-blue-600"}),i[3]||(i[3]=e("span",{class:"font-semibold text-blue-900"},"Information de version",-1))]),e("div",Nt,[e("p",null,[i[4]||(i[4]=re("Version actuelle : ",-1)),e("strong",null,g(L.currentVersion),1)]),e("p",null,[i[5]||(i[5]=re("Nouvelle version : ",-1)),e("strong",null,g(y.value),1)])])]),e("div",Rt,[i[8]||(i[8]=e("label",{class:"block text-sm font-medium mb-3 text-color-secondary"},"Type de version *",-1)),e("div",Ut,[e("div",Pt,[t(n(ue),{modelValue:f.value.versionType,"onUpdate:modelValue":i[0]||(i[0]=M=>f.value.versionType=M),inputId:"minor",value:"minor",class:Y({"p-invalid":u.value.versionType})},null,8,["modelValue","class"]),i[6]||(i[6]=e("label",{for:"minor",class:"ml-2 cursor-pointer"},[e("div",null,[e("span",{class:"font-medium"},"Mineure"),e("p",{class:"text-xs text-color-secondary"},"Corrections, mises à jour mineures")])],-1))]),e("div",qt,[t(n(ue),{modelValue:f.value.versionType,"onUpdate:modelValue":i[1]||(i[1]=M=>f.value.versionType=M),inputId:"major",value:"major",class:Y({"p-invalid":u.value.versionType})},null,8,["modelValue","class"]),i[7]||(i[7]=e("label",{for:"major",class:"ml-2 cursor-pointer"},[e("div",null,[e("span",{class:"font-medium"},"Majeure"),e("p",{class:"text-xs text-color-secondary"},"Changements significatifs")])],-1))])]),u.value.versionType?(c(),k("small",Ot,g(u.value.versionType),1)):E("",!0)]),e("div",Ht,[i[9]||(i[9]=e("label",{for:"file",class:"block text-sm font-medium mb-2 text-color-secondary"},"Nouveau fichier *",-1)),t(n(De),{mode:"basic",auto:!1,chooseLabel:"Choisir un fichier",onSelect:l,maxFileSize:10485760,class:Y({"p-invalid":u.value.file})},null,8,["class"]),S.value?(c(),k("small",Kt," Fichier sélectionné : "+g(S.value),1)):E("",!0),u.value.file?(c(),k("small",Gt,g(u.value.file),1)):E("",!0)]),e("div",Qt,[i[10]||(i[10]=e("label",{for:"changelog",class:"block text-sm font-medium mb-2 text-color-secondary"},"Description des changements *",-1)),t(n(Ce),{id:"changelog",modelValue:f.value.changelog,"onUpdate:modelValue":i[2]||(i[2]=M=>f.value.changelog=M),rows:"5",placeholder:"Décrivez les modifications apportées dans cette version (minimum 10 caractères)...",class:Y(["w-full",{"p-invalid":u.value.changelog}])},null,8,["modelValue","class"]),e("small",Jt,g(f.value.changelog.length)+" / 10 caractères minimum",1),u.value.changelog?(c(),k("small",Wt,g(u.value.changelog),1)):E("",!0)])])]),_:1},8,["visible"])}}}),Yt={key:0,class:"p-4 flex flex-col"},Zt={class:"flex flex-col md:flex-row md:items-center md:justify-between mb-2"},es={class:"flex items-center gap-4"},ts={class:"mt-0!"},ss={class:"flex gap-2"},os={class:"flex justify-end gap-2 mb-2"},ns={class:"grid grid-cols-1 lg:grid-cols-3 gap-6"},rs={class:"lg:col-span-2 flex flex-col gap-6"},ls={class:"flex items-center gap-2 mb-2"},as={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},is={key:1,class:"text-color-secondary"},cs={class:"font-medium text-color"},ds={class:"font-medium text-color"},us={class:"font-medium text-color"},ms={key:0},ps={class:"font-medium text-color"},vs={key:1},fs={class:"font-medium text-color"},ys={key:2},_s={class:"font-medium text-red-500"},gs={key:0,class:"mt-4 pt-4 border-t border-surface-border"},xs={class:"text-color"},hs={class:"flex flex-col gap-6"},bs={class:"flex items-center gap-2 mb-2"},ws={class:"flex flex-col gap-3 text-sm"},ks={class:"flex justify-between"},$s=["title"],Ds={class:"flex justify-between"},Cs={class:"text-color"},Ss={class:"flex justify-between"},Vs=["title"],js={class:"flex items-center gap-2 mb-2"},Ts={key:0,class:"flex flex-col gap-3"},Fs=["onClick"],Is={class:"flex justify-between items-start mb-1"},Es={class:"font-medium text-color text-sm line-clamp-2"},zs={class:"flex justify-between items-center text-xs text-color-secondary"},Ls={key:0},As={key:1,class:"text-color-secondary text-sm italic"},Bs={key:1,class:"flex justify-center py-12"},Ms=J({__name:"DocumentDetail",setup(L){const $=_e(),v=te(),b=se(),f=he(),S=je(),u=le(),y=X(),a=j(!1),l=j(!1),s=R(()=>b.currentDocument),D=()=>{v.back()},B=()=>{v.push(`/documents/${$.params.id}/edit`)},F=async()=>{if(s.value)try{y.add({severity:"info",summary:"Téléchargement",detail:"Le téléchargement a commencé...",life:3e3}),await b.downloadDocument(s.value.id,s.value.filename)}catch{y.add({severity:"error",summary:"Erreur",detail:"Erreur lors du téléchargement",life:3e3})}},x=()=>{u.require({message:"Voulez-vous vraiment supprimer ce document ?",header:"Confirmation",icon:"exclamation-triangle",acceptClass:"p-button-danger",rejectClass:"p-button-secondary",rejectLabel:"Annuler",acceptLabel:"Supprimer",accept:async()=>{try{s.value&&(await b.deleteDocument(s.value.id),y.add({severity:"success",summary:"Succès",detail:"Document supprimé",life:3e3}),v.push("/documents"))}catch{y.add({severity:"error",summary:"Erreur",detail:"Erreur lors de la suppression",life:3e3})}}})},i=()=>{a.value=!0},A=async p=>{if(s.value){l.value=!0;try{const d=new FormData;d.append("file",p.file),d.append("changelog",p.changelog),d.append("version_type",p.versionType),await f.createVersion(s.value.id,d),y.add({severity:"success",summary:"Succès",detail:"Nouvelle version créée avec succès",life:3e3}),a.value=!1,await b.fetchDocumentById(parseInt($.params.id)),await f.fetchVersions(s.value.id)}catch(d){console.error("Error uploading version:",d),y.add({severity:"error",summary:"Erreur",detail:"Impossible de créer la nouvelle version",life:3e3})}finally{l.value=!1}}},M=p=>{u.require({message:`Voulez-vous vraiment restaurer la version ${p.version} ? Cela créera une nouvelle version majeure basée sur ce fichier.`,header:"Confirmation de restauration",icon:"pi pi-exclamation-triangle",acceptClass:"p-button-warning",acceptLabel:"Restaurer",rejectLabel:"Annuler",accept:async()=>{try{await f.restoreVersion(p.id),y.add({severity:"success",summary:"Succès",detail:"Version restaurée avec succès",life:3e3}),s.value&&await b.fetchDocumentById(s.value.id)}catch{y.add({severity:"error",summary:"Erreur",detail:"Impossible de restaurer la version",life:3e3})}}})},G=R(()=>["admin","manager"].includes(S.user?.role||"")),m=async()=>{if(s.value)try{await b.requestApproval(s.value.id),y.add({severity:"success",summary:"Succès",detail:"Demande d'approbation envoyée",life:3e3})}catch{y.add({severity:"error",summary:"Erreur",detail:"Erreur lors de la demande",life:3e3})}},o=async()=>{if(s.value)try{await b.approveDocument(s.value.id),y.add({severity:"success",summary:"Succès",detail:"Document approuvé",life:3e3})}catch{y.add({severity:"error",summary:"Erreur",detail:"Erreur lors de l'approbation",life:3e3})}},T=async()=>{if(s.value)try{await b.rejectDocument(s.value.id),y.add({severity:"success",summary:"Succès",detail:"Document rejeté",life:3e3})}catch{y.add({severity:"error",summary:"Erreur",detail:"Erreur lors du rejet",life:3e3})}},z=p=>p?new Date(p).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-",I=p=>{if(p===void 0)return"-";if(p===0)return"0 B";const d=1024,_=["B","KB","MB","GB","TB"],O=Math.floor(Math.log(p)/Math.log(d));return parseFloat((p/Math.pow(d,O)).toFixed(2))+" "+_[O]},w=p=>{if(!p)return"file";switch(p.split(".").pop()?.toLowerCase()){case"pdf":return"file-pdf";case"doc":case"docx":return"file-word";case"xls":case"xlsx":return"file-excel";case"jpg":case"png":case"jpeg":return"image";default:return"file"}},Q=p=>p?{draft:"Brouillon",pending_approval:"En attente",approved:"Approuvé",rejected:"Rejeté",archived:"Archivé"}[p]||p:"-",oe=p=>p&&{draft:"secondary",pending_approval:"warn",approved:"success",rejected:"danger",archived:"contrast"}[p]||"secondary",h=p=>p?{low:"Basse",medium:"Moyenne",high:"Haute",critical:"Critique"}[p]||p:"-",N=p=>p?{low:"info",medium:"warn",high:"danger",critical:"danger"}[p]||"info":"secondary";return Z(async()=>{const p=parseInt($.params.id);p&&await b.fetchDocumentById(p)}),(p,d)=>{const _=W("font-awesome-icon"),O=Se;return c(),k(ne,null,[s.value?(c(),k("div",Yt,[e("div",Zt,[e("div",es,[t(n(C),{text:"",rounded:"",severity:"secondary",onClick:D},{icon:r(()=>[t(_,{icon:"arrow-left"})]),_:1}),e("h2",ts,g(s.value.title),1),t(n(H),{value:Q(s.value.status),severity:oe(s.value.status)},null,8,["value","severity"])]),e("div",ss,[t(O,null,{default:r(()=>[s.value.status==="approved"?(c(),V(n(C),{key:0,label:"Nouvelle version",severity:"info",onClick:i},{icon:r(()=>[t(_,{icon:"upload"})]),_:1})):E("",!0),t(n(C),{label:"Télécharger",severity:"primary",onClick:F},{icon:r(()=>[t(_,{icon:"download"})]),_:1}),t(n(C),{label:"Modifier",severity:"success",onClick:B},{icon:r(()=>[t(_,{icon:"pencil"})]),_:1}),t(n(C),{label:"Supprimer",severity:"danger",onClick:x},{icon:r(()=>[t(_,{icon:"trash"})]),_:1})]),_:1})])]),e("div",os,[s.value.status==="draft"||s.value.status==="rejected"?(c(),V(n(C),{key:0,label:"Demander approbation",severity:"help",onClick:m},{icon:r(()=>[t(_,{icon:"paper-plane"})]),_:1})):E("",!0),s.value.status==="pending_approval"&&G.value?(c(),V(O,{key:1},{default:r(()=>[t(n(C),{label:"Rejeter",severity:"danger",outlined:"",onClick:T},{icon:r(()=>[t(_,{icon:"times"})]),_:1}),t(n(C),{label:"Approuver",severity:"success",onClick:o},{icon:r(()=>[t(_,{icon:"check"})]),_:1})]),_:1})):E("",!0)]),e("div",ns,[e("div",rs,[t(n(K),null,{title:r(()=>[e("div",ls,[t(_,{icon:"info-circle"}),d[1]||(d[1]=e("span",null,"Informations Générales",-1))])]),content:r(()=>[e("div",as,[e("div",null,[d[2]||(d[2]=e("span",{class:"block text-sm text-color-secondary font-bold"},"Type : ",-1)),s.value.category?(c(),V(n(H),{key:0,value:s.value.category.name,style:ye({backgroundColor:s.value.category.color||"var(--surface-500)",color:"#fff"})},{icon:r(()=>[s.value.category.icon?(c(),V(_,{key:0,icon:["fas",s.value.category.icon],class:"mr-1"},null,8,["icon"])):E("",!0)]),_:1},8,["value","style"])):(c(),k("span",is,"Non défini"))]),e("div",null,[d[3]||(d[3]=e("span",{class:"block text-sm text-color-secondary font-bold"},"Version : ",-1)),e("span",cs,g(s.value.version),1)]),e("div",null,[d[4]||(d[4]=e("span",{class:"block text-sm text-color-secondary font-bold"},"Créé par : ",-1)),e("span",ds,g(s.value.creator?.first_name)+" "+g(s.value.creator?.last_name),1)]),e("div",null,[d[5]||(d[5]=e("span",{class:"block text-sm text-color-secondary font-bold"},"Date de création : ",-1)),e("span",us,g(z(s.value.created_at)),1)]),s.value.approver?(c(),k("div",ms,[d[6]||(d[6]=e("span",{class:"block text-sm text-color-secondary font-bold"},"Approuvé par : ",-1)),e("span",ps,g(s.value.approver?.first_name)+" "+g(s.value.approver?.last_name),1)])):E("",!0),s.value.published_date?(c(),k("div",vs,[d[7]||(d[7]=e("span",{class:"block text-sm text-color-secondary font-bold"},"Date de publication",-1)),e("span",fs,g(z(s.value.published_date)),1)])):E("",!0),s.value.expires_date?(c(),k("div",ys,[d[8]||(d[8]=e("span",{class:"block text-sm text-color-secondary font-bold"},"Date d'expiration : ",-1)),e("span",_s,g(z(s.value.expires_date)),1)])):E("",!0)]),s.value.description?(c(),k("div",gs,[d[9]||(d[9]=e("span",{class:"block text-sm text-color-secondary font-bold mb-1"},"Description : ",-1)),e("p",xs,g(s.value.description),1)])):E("",!0)]),_:1}),s.value?(c(),V(Lt,{key:0,"document-id":s.value.id,"current-version":s.value.version,onRestore:M},null,8,["document-id","current-version"])):E("",!0)]),e("div",hs,[t(n(K),null,{title:r(()=>[e("div",bs,[t(_,{icon:"file"}),d[10]||(d[10]=e("span",null,"Fichier",-1))])]),content:r(()=>[e("div",ws,[e("div",ks,[d[11]||(d[11]=e("span",{class:"text-color-secondary font-bold"},"Nom : ",-1)),e("span",{class:"text-color truncate",title:s.value.filename},g(s.value.filename),9,$s)]),e("div",Ds,[d[12]||(d[12]=e("span",{class:"text-color-secondary font-bold"},"Taille : ",-1)),e("span",Cs,g(I(s.value.file_size)),1)]),e("div",Ss,[d[13]||(d[13]=e("span",{class:"text-color-secondary font-bold"},"Type MIME : ",-1)),e("span",{class:"text-color truncate",title:s.value.mime_type},g(s.value.mime_type||"-"),9,Vs),t(_,{icon:w(s.value.filename)},null,8,["icon"])])])]),_:1}),t(n(K),null,{title:r(()=>[e("div",js,[t(_,{icon:"tasks"}),d[14]||(d[14]=e("span",null,"Actions Liées",-1))])]),content:r(()=>[s.value.actions&&s.value.actions.length>0?(c(),k("div",Ts,[(c(!0),k(ne,null,Ve(s.value.actions,q=>(c(),k("div",{key:q.id,class:"p-3 border rounded-lg hover:bg-surface-50 cursor-pointer transition-colors",onClick:Gs=>n(v).push(`/actions/${q.id}`)},[e("div",Is,[e("span",Es,g(q.title),1),t(n(H),{severity:N(q.priority),class:"text-xs",value:h(q.priority).charAt(0)},null,8,["severity","value"])]),e("div",zs,[e("span",null,g(Q(q.status)),1),q.due_date?(c(),k("span",Ls,g(z(q.due_date)),1)):E("",!0)])],8,Fs))),128))])):(c(),k("div",As,"Aucune action liée."))]),_:1})])])])):(c(),k("div",Bs,[t(_,{icon:["fas","spinner"],spin:"",size:"2x",class:"text-gray-500"})])),s.value?(c(),V(Xt,{key:2,visible:a.value,"onUpdate:visible":d[0]||(d[0]=q=>a.value=q),"current-version":s.value.version,loading:l.value,onUpload:A},null,8,["visible","current-version","loading"])):E("",!0)],64)}}}),eo=Object.freeze(Object.defineProperty({__proto__:null,default:Ms},Symbol.toStringTag,{value:"Module"})),Ns={class:"p-4"},Rs={class:"flex flex-col md:flex-row md:items-center md:justify-between mb-2 gap-4"},Us={class:"flex items-center gap-4"},Ps={key:0,class:"flex justify-center items-center py-12"},qs={key:1,class:"flex justify-center items-center py-12"},Os={key:2,class:"flex justify-center items-center py-12"},Hs={class:"text-lg text-red-600"},Ks=J({__name:"DocumentEdit",setup(L){const $=te(),v=_e(),b=se(),f=X(),S=j({title:"",description:"",document_folder_id:null,category_id:null,version:"",status:"draft"}),u=j(!1),y=j(!1),a=j(""),l=async()=>{u.value=!0,a.value="";try{if(await b.fetchDocumentById(parseInt(v.params.id)),b.currentDocument){const x=b.currentDocument;S.value={title:x.title,description:x.description||"",document_folder_id:x.document_folder_id||null,category_id:x.category?.id||null,version:x.version,status:x.status}}else a.value="Document non trouvé"}catch(x){a.value="Erreur lors du chargement du document",console.error(x)}finally{u.value=!1}},s=async x=>{y.value=!0,a.value="";try{const i=new FormData;if(i.append("_method","PUT"),i.append("title",x.title),i.append("description",x.description??""),x.document_folder_id&&i.append("document_folder_id",x.document_folder_id.toString()),x.category_id&&i.append("category_id",x.category_id.toString()),i.append("version",x.version),i.append("status",x.status),x.expires_date){const M=new Date(x.expires_date).toISOString().split("T")[0];i.append("expires_date",M??"")}x.file&&i.append("file",x.file),await b.updateDocument(parseInt(v.params.id),i),f.add({severity:"success",summary:"Succès",detail:"Document mis à jour avec succès",life:3e3,icon:"check"}),$.push("/documents")}catch(i){f.add({severity:"error",summary:"Erreur",detail:"Impossible de mettre à jour le document",life:3e3}),console.error(i)}finally{y.value=!1}},D=()=>{$.push("/documents")};Z(()=>{l()});const B=()=>{$.back()},F=R(()=>b.currentDocument);return(x,i)=>{const A=W("font-awesome-icon");return c(),k("div",Ns,[e("div",Rs,[e("div",Us,[t(n(C),{text:"",rounded:"",severity:"secondary",onClick:B},{icon:r(()=>[t(A,{icon:"arrow-left"})]),_:1}),i[0]||(i[0]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("h2",{class:"text-color"},"Modifier le document")])],-1))])]),u.value?(c(),k("div",Ps,[t(A,{icon:["fas","spinner"],spin:"",size:"2x",class:"text-color-secondary"})])):!F.value&&!a.value?(c(),k("div",qs,[...i[1]||(i[1]=[e("p",{class:"text-lg text-color-secondary"},"Document non trouvé",-1)])])):a.value?(c(),k("div",Os,[e("p",Hs,g(a.value),1)])):(c(),V(n(K),{key:3},{content:r(()=>[t(xe,{initialData:S.value,submitButtonText:"Enregistrer",loading:y.value,isEditMode:!0,onSubmit:s,onCancel:D},null,8,["initialData","loading"])]),_:1}))])}}}),to=Object.freeze(Object.defineProperty({__proto__:null,default:Ks},Symbol.toStringTag,{value:"Module"}));export{Ys as D,Zs as a,eo as b,to as c};
